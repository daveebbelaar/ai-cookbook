# مدیریت چرخه حیات در MCP

مدیریت چرخه عمر یک جنبه مهم از پروتکل زمینه مدل (MCP) است که به شما کمک می کند تا اولیه ، عملکرد و خاتمه سرورها و مشتری های MCP را کنترل کنید.درک مدیریت چرخه عمر برای ساخت برنامه های قوی MCP ضروری است.

## مدیریت چرخه عمر چیست؟

مدیریت چرخه عمر در MCP به فرایند شروع صحیح ، حفظ و خاتمه ارتباطات بین مشتری و سرورهای MCP اشاره دارد.این تضمین می کند که منابع به درستی اختصاص داده شده و آزاد شده اند و کانال های ارتباطی به درستی ایجاد و بسته می شوند.

## مؤلفه های اصلی مدیریت چرخه عمر

### 1. اولیه سازی

اولیه سازی اولین قدم در چرخه عمر MCP است:

- ** اولیه سازی مشتری **: مشتری ارتباطی به سرور برقرار می کند و نسخه های پروتکل را مذاکره می کند
- ** اولیه سازی سرور **: سرور درخواست مشتری را تأیید می کند و برای رسیدگی به تماس های ابزار آماده می شود
- ** مذاکره نسخه **: هر دو طرف در مورد نسخه پروتکل سازگار برای استفاده برای جلسه موافق هستند

`` `پایتون
# مثال اولیه سازی مشتری
async با stdio_client (server_params) به عنوان (بخوانید ، بنویسید):
async با مشتری (بخوانید ، بنویسید) به عنوان جلسه:
# اتصال را آغاز کنید
Await Session.Initialize ()
`` `

### 2. عملیات

در مرحله کار:

- ** ثبت نام ابزار **: سرور ابزارهای خود را در معرض مشتری قرار می دهد
- ** کشف ابزار **: مشتری ابزارهای موجود را از سرور کشف می کند
- ** اجرای ابزار **: مشتری با ابزار تماس می گیرد و سرور آنها را اجرا می کند
- ** مدیریت منابع **: سرور منابع مورد نیاز برای اجرای ابزار را مدیریت می کند

`` `پایتون
# مثال کشف ابزار
tools_result = منتظر جلسه. list_tools ()
چاپ ("ابزارهای موجود:")
برای ابزار در Tools_result.tools:
چاپ (f " - {tool.name}: {tool.description}")

# مثال اجرای ابزار
نتیجه = منتظر جلسه. call_tool (
tool_call.function.name ،
آرگومان = json.loads (tool_call.function.argument) ،
)
`` `

### 3. خاتمه

خاتمه پاکسازی مناسب را تضمین می کند:

- ** پاکسازی منابع **: کلیه منابع اختصاص یافته در طول جلسه منتشر می شوند
- ** بسته شدن اتصال **: کانال های ارتباطی به درستی بسته شده اند
- ** تنظیم مجدد حالت **: حالت سرور برای جلسه بعدی تنظیم مجدد است

`` `پایتون
# خاتمه هنگام خروج از مدیر زمینه به طور خودکار اتفاق می افتد
async با مشتری (بخوانید ، بنویسید) به عنوان جلسه:
# عملیات جلسه
# ...
# جلسه به طور خودکار در اینجا خاتمه می یابد
`` `

## مدیریت چرخه عمر پیشرفته با شیء طول عمر

برای برنامه های پیچیده تر ، MCP ویژگی ای به نام ** Lifespan Object ** را ارائه می دهد که به مدیریت منابع سطح برنامه در کل چرخه عمر یک سرور MCP کمک می کند.

### شیء طول عمر چیست؟

شیء طول عمر یک مدیر زمینه ناهمزمان است که:

1. با شروع سرور منابع را آغاز می کند
2. این منابع را در طول عملکرد سرور در دسترس همه ابزارها قرار می دهد
3. هنگام خاموش شدن سرور ، منابع را به درستی تمیز می کند

### نحوه استفاده از شیء طول عمر

`` `پایتون
از ContextLib واردات asynccontextmanager
از Collections.Abc واردات asyncitor
از داده های دیتاكاكه دیتاكلاس وارد می كنند

از زمینه واردات MCP.Server.FastMcp ، FastMCP

# کلاس متن ایمن را تعریف کنید
dataclass
کلاس AppContext:
DB: پایگاه داده # با نوع منبع واقعی خود جایگزین کنید

# مدیر زمینه طول عمر را ایجاد کنید
AsynccontextManager
Async def app_lifespan (سرور: FastMCP) -> asynciterator [appContext]:
# منابع را در راه اندازی اولیه کنید
DB = Await Database.Connect ()
سعی کنید:
# منابع را در طول کار در دسترس قرار دهید
عملکرد AppContext (db = db)
سرانجام:
# منابع را در خاموش کردن پاک کنید
منتظر db.disconnect ()

# سرور MCP را با طول عمر ایجاد کنید
MCP = FastMCP ("برنامه من" ، طول عمر = APP_LIFESPAN)

# از زمینه طول عمر در ابزارها استفاده کنید
@mcp.tool ()
def query_db (ctx: متن) -> str:
"" "ابزاری که از منابع اولیه استفاده می کند" "
db = ctx.request_context.lifespan_context.db
بازگشت db.query ()
`` `

### مزایای استفاده از شیء طول عمر

1. ** نوع ایمنی نوع **: زمینه طول عمر به شدت تایپ شده است ، و پشتیبانی بهتر از IDE و بررسی خطا را ارائه می دهد
2. ** مدیریت منابع **: تضمین می کند که منابع به درستی اولیه و تمیز می شوند
3. ** تزریق وابستگی **: یک روش تمیز برای تزریق وابستگی ها به ابزارها فراهم می کند
4. ** جدایی نگرانی ها **: مدیریت منابع را از اجرای ابزار جدا می کند

## نتیجه گیری

با درک و اجرای فازهای اولیه ، بهره برداری و خاتمه به درستی و استفاده از شیء طول عمر برای منابع سطح برنامه ، می توانید ادغام های MCP قابل اعتماد ، کارآمدتر و ایمن تر ایجاد کنید.

برای کسب اطلاعات بیشتر در مورد مدیریت چرخه عمر ، به [MCP Lifecycle] مراجعه کنید (https://modelcontextprotocol.io/specification/2025-03-26/basic/lifecycle#lifecycle).